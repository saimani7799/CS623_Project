CREATE EXTENSION postgis;
SELECT postgis_version();
SELECT postgis_full_version();


-- RETREIEVE FEATURE LOCATIONS
SELECT id, name, ST_AsText(geom) AS geom
	FROM nyc_subway_stations 
	WHERE ST_Equals(geom, '010100002026690000CBE327F938CD21415EDBE1572D315141');

SELECT id, name, oneway, type, ST_AsText(geom) AS geom
	FROM nyc_streets 
	WHERE ST_Equals(geom, '0105000020266900000100000001020000000200000007ED1E8255E821418938A06E0C245141F648D430ACE9214140E06AFB12245141');

SELECT id, name, borough, closed, ST_AsText(geom) AS geom
	FROM nyc_subway_stations
	WHERE ST_Equals(geom, '010100002026690000DB3E61CBC4082241FE1D6A541D3F5141');


-- INTERSECTIONS
-- 1. Cortlandt St
SELECT id, name, ST_AsText(geom)
	FROM nyc_neighborhoods
	WHERE ST_Intersects(geom, ST_GeomFromText('POINT(583521.854408956 4507077.862599085)', 26918));

-- 2.170th St
SELECT id, name, ST_AsText(geom)
	FROM nyc_neighborhoods
	WHERE ST_Intersects(geom, ST_GeomFromText('POINT(591583.6111452815 4521434.846626811)', 26918));

-- 3. Walsh Ct
SELECT id, name, ST_AsText(geom)
	FROM nyc_neighborhoods
	WHERE ST_Intersects(geom, ST_GeomFromText(ST_AsText('01050000202669000001000000010200000002000000378C1A64D1E72141519F66C38C2851415D5A69B70CE921411DAE552294285141') ,26918));


-- DISTANCE BETWEEN POINTS
SELECT ST_Distance(
	ST_GeomFromText('POINT(583521.854408956 4507077.862599085)'),
	ST_GeomFromText('LINESTRING(2 2,-2 2)')
);

SELECT ST_MaxDistance(
	'POINT(583521.854408956 4507077.862599085)'::geometry, 
	'LINESTRING (2 2,2 2)'::geometry
);


-- FEATURES WITHIN DISTANCE -> 200meters
SELECT id, name, ST_AsText(geom)
	FROM nyc_streets
	WHERE ST_DWithin(
		geom,
		ST_GeomFromText('POINT(583521.854408956 4507077.862599085)', 26918),
		200
	)
	ORDER BY id
	LIMIT 3;
	
SELECT id, name, ST_AsText(geom)
	FROM nyc_streets
	WHERE ST_DWithin(
		geom,
		ST_GeomFromText(ST_AsText('0105000020266900000100000001020000000B00000021B940E5CFE62141347052C02D3751415BAA99EFE0E72141809AF74D1B375141E34A39A8F2E821417A5206DC08375141C3F8719105EA214118E49463F63651416D36F64215EB214116FFB714E43651418BFB01A083EB2141D2FDC042DC365141CB2403E391EC21417B124F5BCA365141F817042518ED21416BC2C248C1365141A4FFB24424EE214130663C38AF3651418A190B46A3EF214152B3468F953651418DB42EE4E5EF2141C216EA0591365141'), 26918),
		200
	)
	ORDER BY id
	LIMIT 3;

SELECT id, name, ST_AsText(geom)
	FROM nyc_streets
	WHERE ST_DWithin(
		geom,
		ST_GeomFromText(ST_AsText('01050000202669000001000000010200000004000000EFD76CF5D4E72141D1BE899ABA2B51415C0A71B9ECE72141593457F7BD2B5141F8F16EBE27E82141B4BF5170C42B51416694764678E821418DB5A30CCD2B5141'), 26918),
		200
	)
	ORDER BY id
	LIMIT 3;
	

-- CALCULATE AREAS
SELECT id, name, ST_Area(geom) AS area
	FROM nyc_neighborhoods
	WHERE ST_Equals(geom, '0106000020266900000100000001030000000100000008000000E94FC98149DE214196EF19D1FE3351414271D0B694E821416A36040C4E33514144C142A7CDE721410BCEE0D1A63251412D3D82D36FE72141C6594A6E713251414DA687822AE621415F9731007932514177DB296DE4DA2141B7FDD828003351412DB80BB38EDB2141C844CE8054335141E94FC98149DE214196EF19D1FE335141');

SELECT id, name, ST_Area(geom) AS area
	FROM nyc_neighborhoods
	WHERE ST_Equals(geom, '010600002026690000010000000103000000010000000600000012B6B16AAAF5214104BC4F78B13951413C6E1F0FBAF22141F2E643B1FD385141EDB6EBEC6DEF214151026A2C3A3951417438A35F0DF121412A51F3A3983951414922DA6876F221417E3483BEEA39514112B6B16AAAF5214104BC4F78B1395141');

SELECT id, name, ST_Area(geom) AS area
	FROM nyc_neighborhoods
	WHERE ST_Equals(geom, '010600002026690000010000000103000000010000000F0000008FBA15FEC1D32141289695AE942F5141170BDCF2C6D3214162570DEE952F51410AFFD184FBD62141F7A3F363682F5141D26D99CF5BDA2141894A4E34402F5141B40FDE0FB7DB2141E3E0A60F312F5141C8BDA722C9D92141B5A9C5808C2E5141B8F0E90290D821412BCCFC2C9A2E5141B43BEA07FFD52141AF69CFDDB62E51410DBC14E207D52141C310D0F0C12E514184F1288444D121418A96C72FF42E5141BC713A38C3D0214177FD03CBFA2E5141CB019F6554D12141088B49C11F2F5141E1CBEB47BED1214167119E7A142F514128EB8C2FB8D321417DECF34B952F51418FBA15FEC1D32141289695AE942F5141');


-- LOCATE STATION IN NEIGHBORHOOD
SELECT 
	nyc_neighborhoods.id AS neighborhood_id,
	nyc_neighborhoods.name AS neighborhood_name,
	nyc_neighborhoods.boroname AS neighborhood_boroname
	FROM nyc_neighborhoods
	INNER JOIN nyc_subway_stations
		ON ST_Contains(nyc_neighborhoods.geom, nyc_subway_stations.geom)
	WHERE nyc_subway_stations.name = 'Broad St';

SELECT 
	nyc_neighborhoods.id AS neighborhood_id,
	nyc_neighborhoods.name AS neighborhood_name,
	nyc_neighborhoods.boroname AS neighborhood_boroname,
	ST_Area(nyc_neighborhoods.geom) AS neighborhood_area,
	nyc_subway_stations.name AS subway_station_name
	FROM nyc_neighborhoods
	INNER JOIN nyc_subway_stations
		ON ST_Contains(nyc_neighborhoods.geom, nyc_subway_stations.geom)
	WHERE ST_Equals(nyc_subway_stations.geom, '010100002026690000CBE327F938CD21415EDBE1572D315141');


-- QUERY OPTIMIZATION -> index
CREATE INDEX nyc_neighborhoods_geom_idx
	ON nyc_neighborhoods
	USING GIST(geom);

CREATE INDEX nyc_homicides_geom_idx
	ON nyc_homicides
	USING GIST(geom);

CREATE INDEX nyc_streets_geom_idx
	ON nyc_streets
	USING GIST(geom);

CREATE INDEX nyc_subway_geom_idx
	ON nyc_subway_stations
	USING GIST(geom);
-- DROP INDEX nyc_neighborhoods_geom_idx;
	
	
-- VACUUM TABLES
VACUUM ANALYZE nyc_neighborhoods;
VACUUM ANALYZE nyc_streets;
VACUUM ANALYZE nyc_homicides;
VACUUM ANALYZE nyc_subway_stations;


-- QUERY ANALYSIS
EXPLAIN SELECT * 
	FROM nyc_neighborhoods
	ORDER BY id DESC
	LIMIT 10;
	
EXPLAIN SELECT id, name, ST_AsText(geom)
	FROM nyc_streets
	WHERE ST_DWithin(
		geom,
		ST_GeomFromText('POINT(583521.854408956 4507077.862599085)', 26918),
		200
	)
	ORDER BY id
	LIMIT 3;
	
EXPLAIN SELECT id, name, ST_Area(geom) AS area
	FROM nyc_neighborhoods
	WHERE ST_Equals(geom, '0106000020266900000100000001030000000100000008000000E94FC98149DE214196EF19D1FE3351414271D0B694E821416A36040C4E33514144C142A7CDE721410BCEE0D1A63251412D3D82D36FE72141C6594A6E713251414DA687822AE621415F9731007932514177DB296DE4DA2141B7FDD828003351412DB80BB38EDB2141C844CE8054335141E94FC98149DE214196EF19D1FE335141');

EXPLAIN SELECT id, name, borough, closed, ST_AsText(geom) AS geom
	FROM nyc_subway_stations
	WHERE ST_Equals(geom, '010100002026690000DB3E61CBC4082241FE1D6A541D3F5141');
	
EXPLAIN SELECT ST_Distance(
	ST_GeomFromText('POINT(583521.854408956 4507077.862599085)'),
	ST_GeomFromText('LINESTRING(2 2,-2 2)')
	);

EXPLAIN SELECT 
	nyc_neighborhoods.id AS neighborhood_id,
	nyc_neighborhoods.name AS neighborhood_name,
	nyc_neighborhoods.boroname AS neighborhood_boroname,
	ST_Area(nyc_neighborhoods.geom) AS neighborhood_area,
	nyc_subway_stations.name AS subway_station_name
	FROM nyc_neighborhoods
	INNER JOIN nyc_subway_stations
		ON ST_Contains(nyc_neighborhoods.geom, nyc_subway_stations.geom)
	WHERE ST_Equals(nyc_subway_stations.geom, '010100002026690000CBE327F938CD21415EDBE1572D315141');
